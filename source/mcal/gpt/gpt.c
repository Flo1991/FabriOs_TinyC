/*********************************************************************************************************************/
/**
 *  ______    _          _    ____
 * |  ____|  | |        (_)  / __ \
 * | |__ __ _| |__  _ __ _  | |  | |___
 * |  __/ _` | '_ \| '__| | | |  | / __|
 * | | | (_| | |_) | |  | | | |__| \__ \
 * |_|  \__,_|_.__/|_|  |_|  \____/|___/
 *
 * Tiny C implementation for Attiny2313
 *
 * Copyright (c) 2025, Flo1991
 * BSD 3-Clause License - see LICENSE file for details
 *
 * @file : gpt.c
 * @author : Florian Wank
 * @date : 23.04.2025
 *
 *
 * @brief  source file for timer implementation
 *
 * @details
 * Implementation of a generic timer. Use the 16 bit timer for scheduling. The
 * timer runs at core frequency.
 *
 */
/*********************************************************************************************************************/

/*********************************************************************************************************************
 * Module Includes
 **********************************************************************************************************************/
#include "mcal/gpt/gpt.h"
#include "common/common.h"
#include "common/types.h"
#include "mcal/core/core.h"

/**********************************************************************************************************************
 * Module Definitions
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Module Constants
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Module Enumerations
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Global Variables
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Module Variables
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Module Prototypes
 **********************************************************************************************************************/

/**********************************************************************************************************************
 * Module Function Definitions
 **********************************************************************************************************************/

void gpt_init(void)
{
  /* value to count to (should never be reached as clear be scheduler) */
  /* To do a 16-bit write, the high byte must be written before the low byte */
  *REG_OCR1AH = 0x40;
  *REG_OCR1AL = 0x00;

  /* setup ctc mode and start the timer with no prescaler */
  *REG_TCCR1A = 0;
  *REG_TCCR1B = 0x08 | 1;
}

/*********************************************************************************************************************/
u16 gpt_getCntValue(void)
{
  /* For a 16-bit read, the low byte must be read before the high byte.*/
  u16 cnt = *REG_TCNT1L;
  cnt |= ((u16)(*REG_TCNT1H) << 8);
  return (u16)cnt;
}

/*********************************************************************************************************************/
void gpt_resetCntValue(void)
{
  /* To do a 16-bit write, the high byte must be written before the low byte */
  *REG_TCNT1H = 0;
  *REG_TCNT1L = 0;
}

/*********************************************************************************************************************/
bool gpt_isTimerElapsed(void)
{
  bool ret = false;
  if ((*REG_TIFR & (1 << 6)))
  {
    /* clear flag */
    *REG_TIFR |= (1 << 6); 
    ret = true;
  }
  return ret;
}
